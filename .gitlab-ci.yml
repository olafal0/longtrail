image: golang:latest

stages:
  - test
  - deploy-dev
  - deploy-prod
  - deploy-pages

test:
  stage: test
  script:
    - cd longtrail-api
    - go fmt
    - go vet
    - COVERAGE=`go test -cover -race ./...`

deploy development:
  stage: deploy-dev
  before_script:
    - apt-get update
    - apt-get install -y zip jq python-pip
    - pip install awscli --upgrade
  script:
    - ./scripts/deploy.sh development
    - ./scripts/generate-config.sh development
  artifacts:
    paths:
      - web/config.js
    expire_in: 7 days

deploy production:
  stage: deploy-prod
  only:
    refs:
      - master
  before_script:
    - apt-get update
    - apt-get install -y zip jq python-pip
    - pip install awscli --upgrade
  script:
    - ./scripts/deploy.sh production
    - ./scripts/generate-config.sh production
  artifacts:
    paths:
      - web/config.js
    expire_in: 7 days

pages:
  image: node:latest
  stage: deploy-pages
  dependencies:
    - deploy production
  only:
    refs:
      - master
  script:
    - cd web
    - npm ci
    - parcel build index.html
    - cp -r dist ../pages
  artifacts:
    paths:
      - pages
    expire_in: 7 day
